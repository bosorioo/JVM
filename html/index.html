<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>JVM - Java Virtual Machine: Java Virtual Machine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">JVM - Java Virtual Machine
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Java Virtual Machine </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><pre>
Group members:
    Bruno Osorio
    Joao Araujo
    Leticia Ribeiro
    Tiago Kfouri
    Victoria Goularte
</pre><h1><a class="anchor" id="intro"></a>
Introduction</h1>
<p>Simple implementation of java virtual machine that is able to read class files and display their content and execute the class' main method. <br />
 Not all instructions have been implemented and there are other limitations. Refer to section <a class="el" href="index.html#limitations">Limitations</a> to see more. <br />
</p>
<h1><a class="anchor" id="stepguideJavaClass"></a>
Step-by-step: display class content</h1>
<ol type="1">
<li>Command line are parsed in file <a class="el" href="main_8c.html">main.c</a> to get file path.</li>
<li><a class="el" href="javaclass_8c.html#ae447cd0966dc3beb54467b9097e08f2c" title="Opens a class file and parse it, storing the class information in the JavaClass structure. ">openClassFile()</a> is called, defined in module <a class="el" href="javaclass_8c.html">javaclass.c</a>.</li>
<li>file signature, version and constant pool count are read.</li>
<li><a class="el" href="constantpool_8c.html#a62504539fde83f5183d20f262d4b1943" title="Reads a cp_info from the file. ">readConstantPoolEntry()</a> is called several times to fill the constant pool.</li>
<li><a class="el" href="validity_8c.html#aa0977a766bc0cd47a49ca0e00e706310" title="Iterates over the constant pool looking for inconsistencies in it. ">checkConstantPoolValidity()</a> will check if there are inconsistencies in the constant pool. Refer to section <a class="el" href="index.html#validity">Validity and Errors</a> for verification mades and the ones that aren't.</li>
<li>this class index, super class index and access flags are read and checked using function <a class="el" href="validity_8c.html#a3f8d1665f8c40afb0bf126a9ca693b00" title="Verifies the class indexes and access flags. ">checkClassIndexAndAccessFlags()</a>.</li>
<li>file name is checked against "this class" name to see if they match.</li>
<li>interface count and interfaces' index are read, checking if the indexes are a valid class index.</li>
<li>field count is read, and then several calls to <a class="el" href="fields_8c.html#a5f94d9f571277dfd4d401b69ee8ce0f1" title="Reads a field_info from the file. ">readField()</a> are made to fill in the fields of the class. In this step, the class starts counting how many static fields and instance fields the class has. Thus, when new instances of this class are created later, it is possible to know how many bytes have to be allocated to hold the instance field data. When the class is initialized, it is also possible to know the how many bytes it needs for its static field data.</li>
<li>method count is read, and then several calls to <a class="el" href="methods_8c.html#a0ee1df02a4ba0b51f9e6db74bef74ac9" title="Reads a method_info from the file. ">readMethod()</a> are made to fill in the methods of the class.</li>
<li>attribute count is read, and then several calls to <a class="el" href="attributes_8c.html#a0aab7731ade76c16c2ff8b3bef1111d1">readAttribute()</a> are made to fill in the attributes of the class.</li>
</ol>
<p>Methods and fields can also have attributes, so their read functions also make calls to readAttributes. If no errors occurred during the class loading procedure, then the function <a class="el" href="javaclass_8h.html#a90175fdf9e50aea1c9db6dee3f828e49">printClassFileInfo()</a> is called, and if there were errors, some debug information will show up telling what went wrong.</p>
<p>Note that if the class file name and the class actual name don't match (including package path), the class loading will normally continue, but the JavaClass* structure holding the class information will be marked as name mismatch.</p>
<h1><a class="anchor" id="stepguideJVM"></a>
Step-by-step: execute a class</h1>
<h1><a class="anchor" id="instructions"></a>
Instructions Implementation</h1>
<p>Each instruction is implemented entirely within its single C function. They are all declared in file <a class="el" href="instructions_8c.html">instructions.c</a>. <br />
 All instructions functions share the prefix "instfunc_" and have the same function prototype, which is: </p><div class="fragment"><div class="line">uint8_t instfunc_&lt;instruction name&gt;(<a class="code" href="structJavaVirtualMachine.html">JavaVirtualMachine</a>* jvm, <a class="code" href="structFrame.html">Frame</a>* frame)</div></div><!-- fragment --><p> A <a class="el" href="structFrame.html">Frame</a> structure contains all necessary information to run a method, i.e. the method's bytecode along with its length, the method's program counter, an array storing all local variables and a stack of operands (<a class="el" href="structOperandStack.html">OperandStack</a>). The frame is used to manipulate the operands and the local variables, and read instructions parameters from the method's bytecode. An <a class="el" href="structOperandStack.html">OperandStack</a> is manipulated using functions <a class="el" href="operandstack_8c.html#a303eeaf9017d19267a875dd251fa2857">pushOperand()</a> and <a class="el" href="operandstack_8c.html#a5ba14f5f382f622f8c50f17aed6e3805">popOperand()</a>. <br />
 Instructions use the <a class="el" href="structJavaVirtualMachine.html" title="A java virtual machine, storing all loaded classes, created objects and frames for methods being exec...">JavaVirtualMachine</a> pointer to set errors (like insufficient memory), resolve and look for classes, and create new objects (arrays, class instances, strings). Object creation is done using functions <a class="el" href="jvm_8c.html#a8a0f79bec7b4a76d2ca09ab27342f639">newString()</a>, <a class="el" href="jvm_8c.html#a8bbe91a3e26f98b22758016825b6cdd1">newClassInstance()</a>, <a class="el" href="jvm_8c.html#a718c81a95f3f6222a97b8e8b6980bdcb">newArray()</a>, <a class="el" href="jvm_8c.html#a03c8cda9f6251e682f2b46262b7a672d">newObjectArray()</a> and <a class="el" href="jvm_8c.html#ae92de2ed6014d3c92ec9ea84a3bd4179">newObjectMultiArray()</a>. <br />
 Some instructions are very similar to a few others. In those cases, instructions were implemented using macros to reduce source code length. To see those macros, check file intructions.c.</p>
<h1><a class="anchor" id="validity"></a>
Validity and Errors</h1>
<p>File <a class="el" href="validity_8c.html">validity.c</a> contains various functions to help verify that some invalid configurations of constant pool, fields and methods won't happen. <br />
 Right after reading all entries of the constant pool from the class file, function <a class="el" href="validity_8c.html#aa0977a766bc0cd47a49ca0e00e706310" title="Iterates over the constant pool looking for inconsistencies in it. ">checkConstantPoolValidity()</a> is called. That function will iterate over all constant pool entries, checking them. <br />
 Checks include:</p><ul>
<li>File name / class name match. If they don't, the class will be marked, <a class="el" href="structJavaClass.html#ae51618e3eb35bfce4a1267d57a686259">JavaClass::classNameMismatch</a>.</li>
<li>Class access flags will be checked for invalid flags combination, possibly setting the class status to INVALID_ACCESS_FLAGS or USE_OF_RESERVED_CLASS_ACCESS_FLAGS.</li>
<li>All fields and methods access flags will be checked for invalid flags combination, possibly setting the class status to USE_OF_RESERVED_FIELD_ACCESS_FLAGS, USE_OF_RESERVED_METHOD_ACCESS_FLAGS or INVALID_ACCESS_FLAGS.</li>
<li>Class "this_class" and "super_class" indexes will be checked to see if they point to a valid CONSTANT_Class entry in the constant pool, possibly setting the class status to INVALID_THIS_CLASS_INDEX or INVALID_SUPER_CLASS_INDEX.</li>
<li>Constant pool entries with CONSTANT_Class tag will be checked if name_index points to a valid CONSTANT_Utf8 entry that contains a valid class name, possibly setting the class status to INVALID_NAME_INDEX.</li>
<li>Constant pool entries with CONSTANT_String tag will be checked if string_index points to a valid CONSTANT_Utf8 entry, possibly setting the class status to INVALID_STRING_INDEX.</li>
<li>Contant pool entries with CONSTANT_Methodref or CONSTANT_InterfaceMethodref tag will be checked if name_index points a valid CONSTANT_Utf8 entry, possibly setting the class status to INVALID_CLASS_INDEX. name_and_type index will also be checked to see if they point to a valid CONSTANT_NameAndType. The name_index and descriptor_index of the CONSTANT_NameAndType will be checked to see if it they point to a CONSTANT_Utf8 index. The name_index will be checked to see if it holds a valid method name, and the descriptor will be checked to see if it holds a valid method descriptor. Possible status setting due to errors are: INVALID_CLASS_INDEX, INVALID_NAME_INDEX and INVALID_METHOD_DESCRIPTOR_INDEX.</li>
<li>Contant pool entries with CONSTANT_Fieldref tag will be checked if name_index points a valid CONSTANT_Utf8 entry, possibly setting the class status to INVALID_CLASS_INDEX. name_and_type index will also be checked to see if they point to a valid CONSTANT_NameAndType. The name_index and descriptor_index of the CONSTANT_NameAndType will be checked to see if it they point to a CONSTANT_Utf8 index. The name_index will be checked to see if it holds a valid field name, and the descriptor will be checked to see if it holds a valid field descriptor. Possible status setting due to errors are: INVALID_CLASS_INDEX, INVALID_NAME_INDEX and INVALID_FIELD_DESCRIPTOR_INDEX.</li>
<li>Every time something is read from the class file, it is checked if an End Of File was found too soon. The class status will be changed if an EOF was unexpected. Possible status setting due to EOF related errors are: UNEXPECTED_EOF, UNEXPECTED_EOF_READING_CONSTANT_POOL, UNEXPECTED_EOF_READING_UTF8, UNEXPECTED_EOF_READING_INTERFACES and UNEXPECTED_EOF_READING_ATTRIBUTE_INFO.</li>
<li>Memory allocation failures will set the class status to MEMORY_ALLOCATION_FAILED.</li>
<li>0xCAFEBABE signature will be checked, along with file version. Possible status setting because of this are: CLASS_STATUS_UNSUPPORTED_VERSION or CLASS_STATUS_INVALID_SIGNATURE.</li>
<li>By the end of the class file reading, if there are more data than expected, class status will be changed to FILE_CONTAINS_UNEXPECTED_DATA.</li>
<li>All interfaces' index read are checked to see if they point to a valid CONSTANT_Class entry in the constant pool, possibly setting the class status to INVALID_INTERFACE_INDEX.</li>
<li>All UTF-8 streams are checked for invalid bytes during their extraction from the file, possibly setting the class status to INVALID_UTF8_BYTES.</li>
</ul>
<p>All those status code are defined in <a class="el" href="javaclass_8h.html">javaclass.h</a>, see <a class="el" href="javaclass_8h.html#a9b332e6330d199c30e246d4ad8bff5ac">JavaClassStatus</a> for all status. Errors description can be obtained with the function <a class="el" href="javaclass_8c.html#a38efa2c89d8bc742293cdc1c6e0f3250" title="Decodes JavaClassStatus enumeration elements. ">decodeJavaClassStatus()</a>.</p>
<p>Some other checks while reading attributes (from classes, fields and methods) are also made, possibly setting the class status to: ATTRIBUTE_LENGTH_MISMATCH, ATTRIBUTE_INVALID_CONSTANTVALUE_INDEX, ATTRIBUTE_INVALID_SOURCEFILE_INDEX, ATTRIBUTE_INVALID_INNERCLASS_INDEXES, ATTRIBUTE_INVALID_EXCEPTIONS_CLASS_INDEX or ATTRIBUTE_INVALID_CODE_LENGTH.</p>
<p>There is currently no verification made on instruction parameters and validity of bytecode.</p>
<h1><a class="anchor" id="limitations"></a>
Limitations</h1>
<p>There are a few instructions that haven't been implemented. They are listed below:</p><ul>
<li>invokedynamic - will produce error if executed</li>
<li>checkcast - will produce error if executed</li>
<li>instanceof - will produce error if executed</li>
<li>athrow - will produce error if executed</li>
<li>monitorenter - ignored</li>
<li>monitorexit - ignored</li>
</ul>
<p>There is also no support for exceptions nor try/catch/finally blocks. Class "java/lang/System" and "java/lang/String" can be used, but they are also limited. <br />
 It is possible to print data to stdout using java/lang/System.out.println(), but all other System's methods are unavailable. <br />
 Strings have no methods implemented, therefore they can only be created and printed. Other common instructions that deal with with objects will also work for strings, like comparing them with 'null'. <br />
 Parameter passing from command line to the running java program is not possible. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
