<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JVM: Java Virtual Machine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">JVM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Java Virtual Machine </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><pre>
Group members:
    Bruno Osorio
    Joao Araujo
    Leticia Ribeiro
    Tiago Kfouri
    Victoria Goularte
</pre><h1><a class="anchor" id="intro"></a>
Introduction</h1>
<p>Simple implementation of java virtual machine that is able to read class files and display their content and execute the class' main method. <br />
 Not all instructions have been implemented and there are other limitations. Refer to section <a class="el" href="index.html#limitations">Limitations</a> to see more. <br />
</p>
<h1><a class="anchor" id="stepguideJavaClass"></a>
Step-by-step: display class content</h1>
<ol type="1">
<li>Command line parameters are parsed in file <a class="el" href="main_8c.html">main.c</a> to get the class file path.</li>
<li><a class="el" href="javaclass_8c.html#ae447cd0966dc3beb54467b9097e08f2c" title="Opens a class file and parse it, storing the class information in the JavaClass structure. ">openClassFile()</a> is called, defined in module <a class="el" href="javaclass_8c.html">javaclass.c</a>.</li>
<li>file signature, version and constant pool count are read.</li>
<li><a class="el" href="constantpool_8c.html#a62504539fde83f5183d20f262d4b1943" title="Reads a cp_info from the file. ">readConstantPoolEntry()</a> is called several times to fill the constant pool.</li>
<li><a class="el" href="validity_8c.html#aa0977a766bc0cd47a49ca0e00e706310" title="Iterates over the constant pool looking for inconsistencies in it. ">checkConstantPoolValidity()</a> will check if there are inconsistencies in the constant pool. Refer to section <a class="el" href="index.html#validity">Validity and Errors</a> for verification mades and the ones that aren't.</li>
<li>this class index, super class index and access flags are read and checked using function <a class="el" href="validity_8c.html#a3f8d1665f8c40afb0bf126a9ca693b00" title="Verifies the class indexes and access flags. ">checkClassIndexAndAccessFlags()</a>.</li>
<li>file name is checked against "this class" name to see if they match.</li>
<li>interface count and interfaces' index are read, checking if the indexes are a valid class index.</li>
<li>field count is read, and then several calls to <a class="el" href="fields_8c.html#a5f94d9f571277dfd4d401b69ee8ce0f1" title="Reads a field_info from the file. ">readField()</a> are made to fill in the fields of the class. In this step, the class starts counting how many static fields and instance fields the class has. Thus, when new instances of this class are created later, it is possible to know how many bytes have to be allocated to hold the instance field data. When the class is initialized, it is also possible to know the how many bytes it needs for its static field data.</li>
<li>method count is read, and then several calls to <a class="el" href="methods_8h.html#a0ee1df02a4ba0b51f9e6db74bef74ac9" title="Reads a method_info from the file. ">readMethod()</a> are made to fill in the methods of the class.</li>
<li>attribute count is read, and then several calls to <a class="el" href="attributes_8c.html#a0aab7731ade76c16c2ff8b3bef1111d1">readAttribute()</a> are made to fill in the attributes of the class.</li>
<li>a call to the function <a class="el" href="javaclass_8h.html#a90175fdf9e50aea1c9db6dee3f828e49">printClassFileInfo()</a> will start printing general information of the class, like version, this class index, super class index, constant pool/field/method/interface count and the class access flags.</li>
<li><a class="el" href="javaclass_8h.html#a90175fdf9e50aea1c9db6dee3f828e49">printClassFileInfo()</a> also make calls to <a class="el" href="constantpool_8c.html#ab7d27eb8d4164ae1a1fd11664ba4d1ef" title="Function to print all the constants from the constant pool of the class file. ">printConstantPool()</a>, <a class="el" href="fields_8c.html#a638dfd7ea9c1089e20de1ac871897ddf" title="Function to print all fields of the class file. ">printAllFields()</a>, <a class="el" href="methods_8h.html#a88c1302886452c2888da76abd261ccc8" title="Function to print all methods of the class file. ">printMethods()</a> and <a class="el" href="attributes_8c.html#ae04e26b66957c879139f8a82e463674a">printAllAttributes()</a>.</li>
</ol>
<p>Methods and fields can also have attributes, so their read functions also make calls to readAttributes. If no errors occurred during the class loading procedure, then the function <a class="el" href="javaclass_8h.html#a90175fdf9e50aea1c9db6dee3f828e49">printClassFileInfo()</a> is called, and if there were errors, some debug information will show up telling what went wrong.</p>
<p>Note that if the class file name and the class actual name don't match (including package path), the class loading will normally continue, but the JavaClass* structure holding the class information will be marked as name mismatch.</p>
<h1><a class="anchor" id="stepguideJVM"></a>
Step-by-step: execute a class</h1>
<ol type="1">
<li>Command line parameters are parsed in file <a class="el" href="main_8c.html">main.c</a> to get the class file path.</li>
<li>A <a class="el" href="struct_java_virtual_machine.html" title="A java virtual machine, storing all loaded classes, created objects and frames for methods being exec...">JavaVirtualMachine</a> variable needs to be initialized with a call to <a class="el" href="jvm_8c.html#aca189885e78ec25ece5d7f70e83022a1" title="Initializes a JavaVirtualMachine structure. ">initJVM()</a>.</li>
<li>The file path is passed as parameter to <a class="el" href="jvm_8c.html#afc01abbd34a25316bb3e806471ebdbeb" title="Loads a .class file without initializing it. ">resolveClass()</a>, that will look for the class file, open it and load the class information from it (refer to section <a class="el" href="index.html#stepguideJavaClass">Step-by-step: display class content</a> to see how a class is read).</li>
<li>Once the class is loaded, it is added to the table of all loaded classes so far, see <a class="el" href="struct_loaded_classes.html" title="Linked list data struct that holds information about a class that has already been resolved...">LoadedClasses</a>, <a class="el" href="struct_java_virtual_machine.html#a36266aec8ba9d25b4d9f67509967dd4c" title="Linked list containing all classes that have been resolved by the JVM. ">JavaVirtualMachine::classes</a>.</li>
<li>A call to <a class="el" href="jvm_8c.html#afc01abbd34a25316bb3e806471ebdbeb" title="Loads a .class file without initializing it. ">resolveClass()</a> may trigger other classes resolution (super classes, interfaces implemented etc).</li>
<li>After the main class has been successfully resolved, a call to <a class="el" href="jvm_8c.html#a38b6a19996260e30af5a369a9588dc31" title="Executes the main method of a given class. ">executeJVM()</a> will initialize the class. Class resolution won't initialize the class. The initialization is done only when the class really needs to be initialized. Some instructions will trigger class initialization (new, putstatic, getstatic, putfield, getfield, invokeinterface, invokespecial, invokestatic). <a class="el" href="jvm_8c.html#a38b6a19996260e30af5a369a9588dc31" title="Executes the main method of a given class. ">executeJVM()</a> will make the main class initialize. Class initialization is done by reserving bytes to store the class static data (setting their initial value accordingly if a ConstantValue attribute is present), and calling the <b>&lt;clinit&gt;</b> method of the class. See <a class="el" href="jvm_8c.html#ae702b2c5a05e0f39c5edcaf78bcb4c95" title="Initializes a class. ">initClass()</a>.</li>
<li>After initializing the main class, a method with the signature <b>public static void main(String[] args)</b> will be searched and, if found, called. Method calling is done via <a class="el" href="jvm_8c.html#a84bbfdfb213d48f48d7252c5264c229b" title="Executes the bytecode of a given method. ">runMethod()</a>. Note that the current implementation does not support command line parameter passing to the main method.</li>
<li>When running a method, a frame for it will be created with a call to <a class="el" href="framestack_8c.html#a38bb1bda9e43d71c8472936c0ee14d72" title="A new frame is created each time a method is invoked. ">newFrame()</a>. It will also be added to the stack of frames (<a class="el" href="struct_frame_stack.html" title="Stack of frames to store all frames created by method calling during execution of the JVM...">FrameStack</a>) with a call to <a class="el" href="framestack_8c.html#a173f487de2e018f4d63d576edccb4c3d" title="Push the Frame into the FrameStack passed as parameter by reference. ">pushFrame()</a>. A frame holds the class of the method, the bytecode of the method, the length in bytes of the bytecode, the number of operands that need to be popped from this frame and pushed to a caller frame once the method returns, a stack of operands (<a class="el" href="struct_operand_stack.html">OperandStack</a>) and an array of local variables.</li>
<li>Each instruction is fetched from the Code attribute of the method and the corresponding <a class="el" href="instructions_8h.html#ae8affa9babea747642d20877780599fa">InstructionFunction</a> function pointer is called. Fetch is done with a call to <a class="el" href="instructions_8c.html#a036f840d5a734d71a7807c8d4fc203c6" title="Retrieves the instruction function for a given instruction opcode. ">fetchOpcodeFunction()</a>, which will return one of the functions defined in <a class="el" href="instructions_8c.html">instructions.c</a>.</li>
<li>Once a method is finished, its frame will be removed with a call to <a class="el" href="framestack_8c.html#ab279becc7f4fe166543e43d12e45ef56" title="Pop the Frame passed as parameter by reference. ">popFrame()</a>. The frame will be deallocated with <a class="el" href="framestack_8c.html#ac6d7106961bbc47fa0f024aae9ab12f2" title="Free the Frame passed as parameter. ">freeFrame()</a>. If the method returns data, some of its operands in the <a class="el" href="struct_operand_stack.html">OperandStack</a> will be popped and pushed to the caller frame.</li>
<li>After all execution is done, a call to <a class="el" href="jvm_8c.html#a65269d70951aacfe829c89c078dad67a" title="Deallocates all memory used by the JavaVirtualMachine structure. ">deinitJVM()</a> will release all objects created and memory allocation associated with the JVM.</li>
</ol>
<p>All objects creation is done with calls from the following functions: <a class="el" href="jvm_8c.html#a8a0f79bec7b4a76d2ca09ab27342f639">newString()</a>, <a class="el" href="jvm_8c.html#a8bbe91a3e26f98b22758016825b6cdd1">newClassInstance()</a>, <a class="el" href="jvm_8c.html#a718c81a95f3f6222a97b8e8b6980bdcb">newArray()</a>, <a class="el" href="jvm_8c.html#a03c8cda9f6251e682f2b46262b7a672d">newObjectArray()</a> and <a class="el" href="jvm_8c.html#ae92de2ed6014d3c92ec9ea84a3bd4179">newObjectMultiArray()</a>. They are all released after the entire execution of the entry point class is over, during deinitialization of the JVM. Specific object freeing is done with function <a class="el" href="jvm_8c.html#a4496705945248c1e848995ded82012c8">deleteReference()</a>.</p>
<p>String class has no methods implemented, it is only simulated. Class java/lang/System is specifically checked in some instruction for special handling, like getting the static java/lang/System.out and calling its println method. This is implemented in file <a class="el" href="natives_8c.html">natives.c</a>.</p>
<h1><a class="anchor" id="instructions"></a>
Instructions Implementation</h1>
<p>Each instruction is implemented entirely within its single C function. They are all declared in file <a class="el" href="instructions_8c.html">instructions.c</a>. <br />
 All instructions functions share the prefix "instfunc_" and have the same function prototype, which is: </p><div class="fragment"><div class="line">uint8_t instfunc_&lt;instruction name&gt;(<a class="code" href="struct_java_virtual_machine.html">JavaVirtualMachine</a>* jvm, <a class="code" href="struct_frame.html">Frame</a>* frame)</div></div><!-- fragment --><p> A <a class="el" href="struct_frame.html" title="Structure that will be associated with a method and holds the information necessary to run the method...">Frame</a> structure contains all necessary information to run a method, i.e. the method's bytecode along with its length, the method's program counter, an array storing all local variables and a stack of operands (<a class="el" href="struct_operand_stack.html">OperandStack</a>). The frame is used to manipulate the operands and the local variables, and read instructions parameters from the method's bytecode. An <a class="el" href="struct_operand_stack.html">OperandStack</a> is manipulated using functions <a class="el" href="operandstack_8h.html#a6f7339310c50b11f4cbf123170b995aa" title="Push the operand on the top of OperandStack passed as parameter by reference. ">pushOperand()</a> and <a class="el" href="operandstack_8h.html#a56590c037c3d7582d3b3c99037c336c1" title="Pop the operand out of the top of OperandStack passed as parameter by reference. ">popOperand()</a>. <br />
 Instructions use the <a class="el" href="struct_java_virtual_machine.html" title="A java virtual machine, storing all loaded classes, created objects and frames for methods being exec...">JavaVirtualMachine</a> pointer to set errors (like insufficient memory), resolve and look for classes, and create new objects (arrays, class instances, strings). Object creation is done using functions <a class="el" href="jvm_8c.html#a8a0f79bec7b4a76d2ca09ab27342f639">newString()</a>, <a class="el" href="jvm_8c.html#a8bbe91a3e26f98b22758016825b6cdd1">newClassInstance()</a>, <a class="el" href="jvm_8c.html#a718c81a95f3f6222a97b8e8b6980bdcb">newArray()</a>, <a class="el" href="jvm_8c.html#a03c8cda9f6251e682f2b46262b7a672d">newObjectArray()</a> and <a class="el" href="jvm_8c.html#ae92de2ed6014d3c92ec9ea84a3bd4179">newObjectMultiArray()</a>. <br />
 Some instructions are very similar to a few others. In those cases, instructions were implemented using macros to reduce source code length. To see those macros, check file intructions.c.</p>
<h1><a class="anchor" id="validity"></a>
Validity and Errors</h1>
<p>File <a class="el" href="validity_8c.html">validity.c</a> contains various functions to help verify that some invalid configurations of constant pool, fields and methods won't happen. <br />
 Right after reading all entries of the constant pool from the class file, function <a class="el" href="validity_8c.html#aa0977a766bc0cd47a49ca0e00e706310" title="Iterates over the constant pool looking for inconsistencies in it. ">checkConstantPoolValidity()</a> is called. That function will iterate over all constant pool entries, checking them. <br />
 Checks include:</p><ul>
<li>File name / class name match. If they don't, the class will be marked, <a class="el" href="struct_java_class.html#ae51618e3eb35bfce4a1267d57a686259">JavaClass::classNameMismatch</a>.</li>
<li>Class access flags will be checked for invalid flags combination, possibly setting the class status to INVALID_ACCESS_FLAGS or USE_OF_RESERVED_CLASS_ACCESS_FLAGS.</li>
<li>All fields and methods access flags will be checked for invalid flags combination, possibly setting the class status to USE_OF_RESERVED_FIELD_ACCESS_FLAGS, USE_OF_RESERVED_METHOD_ACCESS_FLAGS or INVALID_ACCESS_FLAGS.</li>
<li>Class "this_class" and "super_class" indexes will be checked to see if they point to a valid CONSTANT_Class entry in the constant pool, possibly setting the class status to INVALID_THIS_CLASS_INDEX or INVALID_SUPER_CLASS_INDEX.</li>
<li>Constant pool entries with CONSTANT_Class tag will be checked if name_index points to a valid CONSTANT_Utf8 entry that contains a valid class name, possibly setting the class status to INVALID_NAME_INDEX.</li>
<li>Constant pool entries with CONSTANT_String tag will be checked if string_index points to a valid CONSTANT_Utf8 entry, possibly setting the class status to INVALID_STRING_INDEX.</li>
<li>Contant pool entries with CONSTANT_Methodref or CONSTANT_InterfaceMethodref tag will be checked if name_index points a valid CONSTANT_Utf8 entry, possibly setting the class status to INVALID_CLASS_INDEX. name_and_type index will also be checked to see if they point to a valid CONSTANT_NameAndType. The name_index and descriptor_index of the CONSTANT_NameAndType will be checked to see if it they point to a CONSTANT_Utf8 index. The name_index will be checked to see if it holds a valid method name, and the descriptor will be checked to see if it holds a valid method descriptor. Possible status setting due to errors are: INVALID_CLASS_INDEX, INVALID_NAME_INDEX and INVALID_METHOD_DESCRIPTOR_INDEX.</li>
<li>Contant pool entries with CONSTANT_Fieldref tag will be checked if name_index points a valid CONSTANT_Utf8 entry, possibly setting the class status to INVALID_CLASS_INDEX. name_and_type index will also be checked to see if they point to a valid CONSTANT_NameAndType. The name_index and descriptor_index of the CONSTANT_NameAndType will be checked to see if it they point to a CONSTANT_Utf8 index. The name_index will be checked to see if it holds a valid field name, and the descriptor will be checked to see if it holds a valid field descriptor. Possible status setting due to errors are: INVALID_CLASS_INDEX, INVALID_NAME_INDEX and INVALID_FIELD_DESCRIPTOR_INDEX.</li>
<li>Every time something is read from the class file, it is checked if an End Of File was found too soon. The class status will be changed if an EOF was unexpected. Possible status setting due to EOF related errors are: UNEXPECTED_EOF, UNEXPECTED_EOF_READING_CONSTANT_POOL, UNEXPECTED_EOF_READING_UTF8, UNEXPECTED_EOF_READING_INTERFACES and UNEXPECTED_EOF_READING_ATTRIBUTE_INFO.</li>
<li>Memory allocation failures will set the class status to MEMORY_ALLOCATION_FAILED.</li>
<li>0xCAFEBABE signature will be checked, along with file version. Possible status setting because of this are: CLASS_STATUS_UNSUPPORTED_VERSION or CLASS_STATUS_INVALID_SIGNATURE.</li>
<li>By the end of the class file reading, if there are more data than expected, class status will be changed to FILE_CONTAINS_UNEXPECTED_DATA.</li>
<li>All interfaces' index read are checked to see if they point to a valid CONSTANT_Class entry in the constant pool, possibly setting the class status to INVALID_INTERFACE_INDEX.</li>
<li>All UTF-8 streams are checked for invalid bytes during their extraction from the file, possibly setting the class status to INVALID_UTF8_BYTES.</li>
</ul>
<p>All those status code are defined in <a class="el" href="javaclass_8h.html">javaclass.h</a>, see <a class="el" href="javaclass_8h.html#a9b332e6330d199c30e246d4ad8bff5ac">JavaClassStatus</a> for all status. Errors description can be obtained with the function <a class="el" href="javaclass_8c.html#a38efa2c89d8bc742293cdc1c6e0f3250" title="Decodes JavaClassStatus enumeration elements. ">decodeJavaClassStatus()</a>.</p>
<p>Some other checks while reading attributes (from classes, fields and methods) are also made, possibly setting the class status to: ATTRIBUTE_LENGTH_MISMATCH, ATTRIBUTE_INVALID_CONSTANTVALUE_INDEX, ATTRIBUTE_INVALID_SOURCEFILE_INDEX, ATTRIBUTE_INVALID_INNERCLASS_INDEXES, ATTRIBUTE_INVALID_EXCEPTIONS_CLASS_INDEX or ATTRIBUTE_INVALID_CODE_LENGTH.</p>
<p>There is currently no verification made on instruction parameters and validity of bytecode.</p>
<h1><a class="anchor" id="limitations"></a>
Limitations</h1>
<p>This software must be compiled in 32-bit mode, as pointer are cast to/from integers of 32 bits.</p>
<p>There is no garbage collector, so all memory allocated for objects created will be released only when the program terminates.</p>
<p>There are a few instructions that haven't been implemented. They are listed below:</p><ul>
<li>invokedynamic - will produce error if executed</li>
<li>checkcast - will produce error if executed</li>
<li>instanceof - will produce error if executed</li>
<li>athrow - will produce error if executed</li>
<li>monitorenter - ignored</li>
<li>monitorexit - ignored</li>
</ul>
<p>There is also no support for exceptions nor try/catch/finally blocks. Class "java/lang/System" and "java/lang/String" can be used, but they are also limited. <br />
 It is possible to print data to stdout using java/lang/System.out.println(), but all other System's methods are unavailable. <br />
 Strings have no methods implemented, therefore they can only be created and printed. Other common instructions that deal with with objects will also work for strings, like comparing them with 'null'. <br />
 Parameter passing from command line to the running java program is not possible. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Apr 9 2018 14:36:08 for JVM by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
